<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced File Processing - OCR & Storage</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .processing-info {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .processing-info h3 {
            color: #1976d2;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .processing-rules {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }

        .rule-card {
            background: white;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
        }

        .rule-card h4 {
            color: #1976d2;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rule-card ul {
            list-style: none;
            padding: 0;
        }

        .rule-card li {
            padding: 5px 0;
            color: #424242;
        }

        .rule-card li:before {
            content: "✓";
            color: #4caf50;
            font-weight: bold;
            margin-right: 8px;
        }

        .upload-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px dashed #dee2e6;
            text-align: center;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
        }

        .upload-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .process-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .results-section {
            display: none;
            margin-top: 30px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }

        .result-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #dee2e6;
        }

        .result-card h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .file-display {
            text-align: center;
            margin-bottom: 20px;
        }

        .extracted-image, .file-preview {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .text-display {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            min-height: 200px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
            white-space: pre-wrap;
            overflow-y: auto;
            max-height: 400px;
        }

        .metadata {
            background: #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-size: 0.9em;
        }

        .metadata-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .metadata-label {
            font-weight: bold;
            color: #495057;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4facfe;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            display: none;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            display: none;
        }

        .processing-type-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .badge-ocr {
            background: #28a745;
            color: white;
        }

        .badge-storage {
            background: #007bff;
            color: white;
        }

        .medical-history-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            border: 1px solid #dee2e6;
        }

        .medical-history-section h2 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .history-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .history-stats {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-weight: bold;
            color: #495057;
        }

        .history-files {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .history-file-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .history-file-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .history-file-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .history-file-type {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            color: white;
        }

        .type-image {
            background: #28a745;
        }

        .type-document {
            background: #007bff;
        }

        .history-file-preview {
            text-align: center;
            margin-bottom: 15px;
        }

        .history-file-preview img {
            max-width: 100%;
            max-height: 150px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }

        .history-file-info {
            font-size: 0.9em;
            color: #6c757d;
        }

        .history-file-info p {
            margin: 5px 0;
        }

        .history-file-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .history-file-actions button {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.3s ease;
        }

        .btn-view {
            background: #17a2b8;
            color: white;
        }

        .btn-view:hover {
            background: #138496;
        }

        .btn-download {
            background: #28a745;
            color: white;
        }

        .btn-download:hover {
            background: #218838;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        @media (max-width: 768px) {
            .results-grid, .processing-rules {
                grid-template-columns: 1fr;
            }
            
            .history-files {
                grid-template-columns: 1fr;
            }
            
            .container {
                margin: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📋 Medical History File Manager</h1>
            <p>Upload medical files: Images get OCR text extraction, other files get stored as base64</p>
        </div>

        <div class="main-content">
            <div class="processing-info">
                <h3>🔄 Processing Logic</h3>
                <div class="processing-rules">
                    <div class="rule-card">
                        <h4>🖼️ Image Files</h4>
                        <ul>
                            <li>Extract text using OCR</li>
                            <li>Store as base64 in MongoDB</li>
                            <li>Display image + extracted text</li>
                            <li>Support: JPEG, PNG, GIF, BMP, TIFF</li>
                        </ul>
                    </div>
                    <div class="rule-card">
                        <h4>📁 Other Files</h4>
                        <ul>
                            <li>Convert to base64</li>
                            <li>Store in MongoDB (patients_v2)</li>
                            <li>Display file preview</li>
                            <li>Support: PDF, DOC, DOCX, TXT, etc.</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="upload-section">
                <input type="file" id="fileInput" class="file-input" accept="*/*">
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    📁 Choose File (Any Type)
                </button>
                <button class="upload-btn process-btn" onclick="processFile()" id="processBtn" disabled>
                    🚀 Process File
                </button>
                <p style="margin-top: 10px; color: #6c757d;">Supports: Images (OCR) + Any file type (Storage)</p>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Processing file...</p>
            </div>

            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>

            <div class="results-section" id="resultsSection">
                <h2>📋 Processing Results</h2>
                <div class="results-grid">
                    <div class="result-card">
                        <h3 id="fileTitle">📄 File Preview</h3>
                        <div class="file-display">
                            <img id="filePreview" class="file-preview" style="display: none;" alt="File preview">
                            <div id="fileInfo" style="display: none;">
                                <p><strong>File Type:</strong> <span id="fileType"></span></p>
                                <p><strong>File Size:</strong> <span id="fileSize"></span></p>
                                <p><strong>Processing:</strong> <span id="processingType" class="processing-type-badge"></span></p>
                            </div>
                        </div>
                        <div class="metadata" id="fileMetadata"></div>
                    </div>

                    <div class="result-card">
                        <h3 id="textTitle">📝 Extracted Text</h3>
                        <div class="text-display" id="extractedText">No text extracted</div>
                        <div class="metadata" id="textMetadata"></div>
                    </div>
                </div>
            </div>

            <!-- Medical History Section -->
            <div class="medical-history-section" id="medicalHistorySection" style="display: none; margin-top: 30px;">
                <h2>📚 Medical History</h2>
                    <div class="history-controls">
                        <button class="upload-btn" onclick="refreshMedicalHistory()" id="refreshHistoryBtn">
                            🔄 Refresh History
                        </button>
                        <button class="upload-btn" onclick="testViewDownload()" id="testBtn" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">
                            🧪 Test View/Download
                        </button>
                        <button class="upload-btn" onclick="clearBrowserCache()" id="clearCacheBtn" style="background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);">
                            🧹 Clear Cache
                        </button>
                        <button class="upload-btn" onclick="clearMedicalHistory()" id="clearHistoryBtn" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                            🗑️ Clear History
                        </button>
                    </div>
                    <div class="history-notice" style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; padding: 10px; margin: 10px 0; color: #856404;">
                        <strong>ℹ️ Notice:</strong> Old files without document IDs cannot be viewed/downloaded. Upload new files to get full functionality.
                    </div>
                <div class="history-stats" id="historyStats">
                    <p>📊 <span id="totalFiles">0</span> files in medical history</p>
                </div>
                <div class="history-files" id="historyFiles">
                    <!-- Medical history files will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000/api/v1';
        let selectedFile = null;
        let medicalHistory = [];

        // Handle file selection
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                selectedFile = file;
                console.log('File selected:', file.name, file.type);
                showMessage(`File selected: ${file.name} (${file.type})`, 'success');
                
                // Enable process button
                document.getElementById('processBtn').disabled = false;
                
                // Show file info immediately
                displayFileInfo(file);
            }
        });

        function displayFileInfo(file) {
            const fileInfo = document.getElementById('fileInfo');
            const fileType = document.getElementById('fileType');
            const fileSize = document.getElementById('fileSize');
            const processingType = document.getElementById('processingType');
            
            fileType.textContent = file.type || 'Unknown';
            fileSize.textContent = formatFileSize(file.size);
            
            const isImage = file.type && file.type.startsWith('image/');
            processingType.textContent = isImage ? 'OCR + Storage' : 'Base64 Storage';
            processingType.className = `processing-type-badge ${isImage ? 'badge-ocr' : 'badge-storage'}`;
            
            fileInfo.style.display = 'block';
        }

        async function processFile() {
            if (!selectedFile) {
                showMessage('Please select a file first', 'error');
                return;
            }

            const loading = document.getElementById('loading');
            const resultsSection = document.getElementById('resultsSection');
            const errorMessage = document.getElementById('errorMessage');
            const successMessage = document.getElementById('successMessage');

            // Reset UI
            hideMessages();
            resultsSection.style.display = 'none';

            // Show loading and disable button
            loading.style.display = 'block';
            document.getElementById('processBtn').disabled = true;

            try {
                console.log('Starting file processing...');
                
                // Create FormData
                const formData = new FormData();
                formData.append('file', selectedFile);

                // Make API call
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 second timeout

                const response = await fetch(`${API_BASE_URL}/ocr/upload`, {
                    method: 'POST',
                    body: formData,
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (response.ok) {
                    const result = await response.json();
                    console.log('API Response:', result);

                    // Update UI based on processing type
                    const isImage = result.is_image || false;
                    
                    // Update titles
                    document.getElementById('fileTitle').textContent = isImage ? '🖼️ Image Display' : '📄 File Preview';
                    document.getElementById('textTitle').textContent = isImage ? '📝 Extracted Text' : '📄 File Content';

                    // Display results
                    displayResults(result, selectedFile, isImage);
                    
                    const processingType = isImage ? 'OCR text extraction' : 'base64 storage';
                    showMessage(`File processed successfully! ${isImage ? 'Text extracted and' : 'File'} stored in MongoDB.`, 'success');
                    
                    // Add to medical history and refresh
                    await loadMedicalHistory();
                    
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

            } catch (error) {
                console.error('Error during file processing:', error);
                
                if (error.name === 'AbortError') {
                    showMessage('File processing timed out. Please try again.', 'error');
                } else {
                    showMessage('File processing failed: ' + error.message, 'error');
                }
                
                // Still show the file info
                document.getElementById('resultsSection').style.display = 'block';
                
            } finally {
                loading.style.display = 'none';
                document.getElementById('processBtn').disabled = false;
            }
        }

        async function displayResults(result, file, isImage) {
            const filePreview = document.getElementById('filePreview');
            const extractedText = document.getElementById('extractedText');
            const fileMetadata = document.getElementById('fileMetadata');
            const textMetadata = document.getElementById('textMetadata');

            // Display file preview
            if (isImage) {
                // For images, try to get from API or use local preview
                if (result.document_id) {
                    try {
                        const imageResponse = await fetch(`${API_BASE_URL}/documents/${result.document_id}?include_base64=true`);
                        if (imageResponse.ok) {
                            const imageData = await imageResponse.json();
                            if (imageData.success && imageData.document.base64_data) {
                                filePreview.src = `data:${imageData.document.file_type};base64,${imageData.document.base64_data}`;
                                filePreview.style.display = 'block';
                            }
                        }
                    } catch (error) {
                        console.log('Could not retrieve image from API, using local preview');
                        // Fallback to local preview
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            filePreview.src = e.target.result;
                            filePreview.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                } else {
                    // Fallback to local preview
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        filePreview.src = e.target.result;
                        filePreview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            } else {
                // For non-images, show a generic file icon or base64 preview
                filePreview.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjhmOWZhIiBzdHJva2U9IiNkZWUyZTYiIHN0cm9rZS13aWR0aD0iMiIvPjx0ZXh0IHg9IjUwJSIgeT0iNDAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM2Yzc1N2QiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkZpbGU8L3RleHQ+PHRleHQgeD0iNTAlIiB5PSI1NSUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxMiIgZmlsbD0iIzk5OTk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+U3RvcmVkIGluIE1vbmdvREI8L3RleHQ+PC9zdmc+';
                filePreview.style.display = 'block';
            }

            // Display text content
            if (isImage) {
                extractedText.textContent = result.extracted_text || 'No text extracted from image';
            } else {
                extractedText.textContent = `File stored successfully in MongoDB.\n\nDocument ID: ${result.document_id || 'N/A'}\nPatient ID: ${result.patient_id || 'N/A'}\nFile Size: ${formatFileSize(file.size)}\nFile Type: ${file.type || 'Unknown'}`;
            }

            // Display file metadata
            fileMetadata.innerHTML = `
                <div class="metadata-item">
                    <span class="metadata-label">Filename:</span>
                    <span>${file.name}</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">File Type:</span>
                    <span>${file.type || 'Unknown'}</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">File Size:</span>
                    <span>${formatFileSize(file.size)}</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Processing Type:</span>
                    <span>${result.processing_type || (isImage ? 'OCR + Storage' : 'Base64 Storage')}</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Document ID:</span>
                    <span>${result.document_id || 'N/A'}</span>
                </div>
            `;

            // Display text metadata
            if (isImage) {
                textMetadata.innerHTML = `
                    <div class="metadata-item">
                        <span class="metadata-label">Text Length:</span>
                        <span>${result.text_count || 0} characters</span>
                    </div>
                    <div class="metadata-item">
                        <span class="metadata-label">Processing Time:</span>
                        <span>${result.processing_time || 'N/A'}</span>
                    </div>
                    <div class="metadata-item">
                        <span class="metadata-label">Confidence Score:</span>
                        <span>${result.confidence_score || 'N/A'}</span>
                    </div>
                    <div class="metadata-item">
                        <span class="metadata-label">Processing Method:</span>
                        <span>${result.processing_summary?.method || 'paddleocr'}</span>
                    </div>
                `;
            } else {
                textMetadata.innerHTML = `
                    <div class="metadata-item">
                        <span class="metadata-label">Storage Status:</span>
                        <span>✅ Stored in MongoDB</span>
                    </div>
                    <div class="metadata-item">
                        <span class="metadata-label">Patient ID:</span>
                        <span>${result.patient_id || 'N/A'}</span>
                    </div>
                    <div class="metadata-item">
                        <span class="metadata-label">Document Type:</span>
                        <span>medical_document</span>
                    </div>
                `;
            }

            // Show results
            resultsSection.style.display = 'block';
        }

        function showMessage(message, type) {
            const errorMessage = document.getElementById('errorMessage');
            const successMessage = document.getElementById('successMessage');
            
            if (type === 'error') {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
            } else {
                successMessage.textContent = message;
                successMessage.style.display = 'block';
            }
        }

        function hideMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Medical History Functions
        async function loadMedicalHistory() {
            try {
                console.log('Loading medical history...');
                
                // Use the user email as patient ID
                const patientId = 'arunkumar.loganathan.lm@gmail.com';
                
                // Add cache-busting parameter to ensure fresh data
                const timestamp = new Date().getTime();
                const response = await fetch(`${API_BASE_URL}/patients/${patientId}/documents?limit=50&_t=${timestamp}`, {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    medicalHistory = data.documents || [];
                    console.log('Loaded medical history:', medicalHistory.length, 'documents');
                    
                    // Log document IDs for debugging
                    medicalHistory.forEach((doc, index) => {
                        console.log(`Document ${index + 1}: ${doc.filename} - ID: ${doc.id}`);
                    });
                    
                    displayMedicalHistory();
                } else {
                    console.error('Failed to load medical history:', response.status, response.statusText);
                    // If no patient documents found, show empty state
                    medicalHistory = [];
                    displayMedicalHistory();
                }
                
                // Show the medical history section
                document.getElementById('medicalHistorySection').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading medical history:', error);
                // Show empty medical history
                medicalHistory = [];
                displayMedicalHistory();
                document.getElementById('medicalHistorySection').style.display = 'block';
            }
        }

        function displayMedicalHistory() {
            const historyFiles = document.getElementById('historyFiles');
            const totalFiles = document.getElementById('totalFiles');
            
            // Filter out documents with missing or invalid IDs
            const validDocuments = medicalHistory.filter(doc => {
                const docId = doc.id;
                return docId && docId !== 'null' && docId !== 'undefined' && docId !== null;
            });
            
            console.log(`Displaying ${validDocuments.length} valid documents out of ${medicalHistory.length} total`);
            
            totalFiles.textContent = validDocuments.length;
            
            if (validDocuments.length === 0) {
                historyFiles.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #6c757d;">
                        <h3>📂 No valid files in medical history</h3>
                        <p>Upload files above to add them to your medical history</p>
                        ${medicalHistory.length > 0 ? '<p style="color: #dc3545; margin-top: 10px;">⚠️ Some files have missing document IDs and cannot be displayed</p>' : ''}
                    </div>
                `;
                return;
            }
            
            historyFiles.innerHTML = validDocuments.map(doc => {
                const isImage = doc.document_type === 'medical_image';
                const fileIcon = isImage ? '🖼️' : '📄';
                const typeClass = isImage ? 'type-image' : 'type-document';
                const typeText = isImage ? 'Image' : 'Document';
                
                return `
                    <div class="history-file-card">
                        <div class="history-file-header">
                            <h4>${fileIcon} ${doc.filename}</h4>
                            <span class="history-file-type ${typeClass}">${typeText}</span>
                        </div>
                        
                        <div class="history-file-preview">
                            ${isImage ? 
                                `<div style="padding: 20px; background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 8px; color: #6c757d; text-align: center;">
                                    <p>🖼️ Image Preview</p>
                                    <p style="font-size: 12px;">Click "View" to see the image</p>
                                </div>` :
                                `<div style="padding: 40px; background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 8px; color: #6c757d;">
                                    📄 File Preview
                                </div>`
                            }
                        </div>
                        
                        <div class="history-file-info">
                            <p><strong>Type:</strong> ${doc.file_type || 'Unknown'}</p>
                            <p><strong>Size:</strong> ${formatFileSize(doc.file_size || 0)}</p>
                            <p><strong>Uploaded:</strong> ${new Date(doc.metadata?.upload_timestamp || doc.created_at).toLocaleString()}</p>
                            ${doc.extracted_text ? `<p><strong>Text Length:</strong> ${doc.text_count || 0} characters</p>` : ''}
                            <p><strong>Processing:</strong> ${doc.processing_method || 'Unknown'}</p>
                        </div>
                        
                        <div class="history-file-actions">
                            ${doc.id && doc.id !== 'null' && doc.id !== 'undefined' ? 
                                `<button class="btn-view" onclick="console.log('View button clicked for:', '${doc.id}'); viewFile('${doc.id}')">👁️ View</button>
                                 <button class="btn-download" onclick="console.log('Download button clicked for:', '${doc.id}', '${doc.filename}'); downloadFile('${doc.id}', '${doc.filename}')">⬇️ Download</button>
                                 <button class="btn-delete" onclick="console.log('Delete button clicked for:', '${doc.id}'); deleteFile('${doc.id}')">🗑️ Delete</button>` :
                                `<button class="btn-view" disabled style="opacity: 0.5; cursor: not-allowed;">👁️ View</button>
                                 <button class="btn-download" disabled style="opacity: 0.5; cursor: not-allowed;">⬇️ Download</button>
                                 <button class="btn-delete" disabled style="opacity: 0.5; cursor: not-allowed;">🗑️ Delete</button>
                                 <small style="color: #dc3545; display: block; margin-top: 5px;">⚠️ Document ID missing - cannot view/download</small>`
                            }
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function viewFile(documentId) {
            try {
                console.log('🔍 viewFile called with documentId:', documentId);
                
                if (!documentId || documentId === 'null' || documentId === 'undefined') {
                    console.log('❌ Invalid document ID:', documentId);
                    alert('Cannot view file: Document ID is missing or invalid.');
                    return;
                }

                console.log('✅ Valid document ID, fetching document:', documentId);
                const response = await fetch(`${API_BASE_URL}/documents/${documentId}?include_base64=true`);
                
                if (response.ok) {
                    const data = await response.json();
                    const doc = data.document;
                    
                    console.log('Document retrieved:', doc.filename);
                    
                    // Create a modal or new window to view the file
                    const newWindow = window.open('', '_blank', 'width=800,height=600');
                    newWindow.document.write(`
                        <html>
                            <head><title>${doc.filename}</title></head>
                            <body style="margin: 20px; font-family: Arial, sans-serif;">
                                <h2>📄 ${doc.filename}</h2>
                                <hr>
                                ${doc.base64_data ? 
                                    `<img src="data:${doc.file_type};base64,${doc.base64_data}" style="max-width: 100%; height: auto;">` :
                                    `<p>File preview not available</p>`
                                }
                                ${doc.extracted_text ? 
                                    `<h3>Extracted Text:</h3><pre style="background: #f8f9fa; padding: 15px; border-radius: 5px;">${doc.extracted_text}</pre>` : 
                                    ''
                                }
                                <hr>
                                <p><strong>File Type:</strong> ${doc.file_type}</p>
                                <p><strong>File Size:</strong> ${formatFileSize(doc.file_size || 0)}</p>
                                <p><strong>Uploaded:</strong> ${new Date(doc.metadata?.upload_timestamp || doc.created_at).toLocaleString()}</p>
                            </body>
                        </html>
                    `);
                } else {
                    console.error('Failed to retrieve document:', response.status, response.statusText);
                    alert(`Failed to retrieve document: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                console.error('Error viewing file:', error);
                alert('Error viewing file: ' + error.message);
            }
        }

        async function downloadFile(documentId, filename) {
            try {
                console.log('🔍 downloadFile called with documentId:', documentId, 'filename:', filename);
                
                if (!documentId || documentId === 'null' || documentId === 'undefined') {
                    console.log('❌ Invalid document ID:', documentId);
                    alert('Cannot download file: Document ID is missing or invalid.');
                    return;
                }

                console.log('✅ Valid document ID, fetching document for download:', documentId);
                const response = await fetch(`${API_BASE_URL}/documents/${documentId}?include_base64=true`);
                
                if (response.ok) {
                    const data = await response.json();
                    const doc = data.document;
                    
                    if (doc.base64_data) {
                        // Convert base64 to blob and download
                        const byteCharacters = atob(doc.base64_data);
                        const byteNumbers = new Array(byteCharacters.length);
                        for (let i = 0; i < byteCharacters.length; i++) {
                            byteNumbers[i] = byteCharacters.charCodeAt(i);
                        }
                        const byteArray = new Uint8Array(byteNumbers);
                        const blob = new Blob([byteArray], { type: doc.file_type });
                        
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                        
                        console.log('File downloaded successfully:', filename);
                    } else {
                        alert('File data not available for download.');
                    }
                } else {
                    console.error('Failed to retrieve document for download:', response.status, response.statusText);
                    alert(`Failed to retrieve document: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                console.error('Error downloading file:', error);
                alert('Error downloading file: ' + error.message);
            }
        }

        async function deleteFile(documentId) {
            if (confirm('Are you sure you want to delete this file from your medical history?')) {
                try {
                    // Note: You'll need to implement a delete endpoint in your API
                    alert('Delete functionality needs to be implemented in the API');
                    console.log('Would delete document:', documentId);
                    // await loadMedicalHistory(); // Refresh after deletion
                } catch (error) {
                    console.error('Error deleting file:', error);
                    alert('Error deleting file: ' + error.message);
                }
            }
        }

        async function clearMedicalHistory() {
            if (confirm('Are you sure you want to clear all files from your medical history?')) {
                try {
                    // Note: You'll need to implement a clear endpoint in your API
                    alert('Clear functionality needs to be implemented in the API');
                    console.log('Would clear all medical history');
                    // medicalHistory = [];
                    // displayMedicalHistory();
                } catch (error) {
                    console.error('Error clearing medical history:', error);
                    alert('Error clearing medical history: ' + error.message);
                }
            }
        }

        async function refreshMedicalHistory() {
            try {
                console.log('Refreshing medical history...');
                
                // Clear any cached data
                medicalHistory = [];
                
                // Force a complete refresh
                await loadMedicalHistory();
                showMessage('Medical history refreshed successfully!', 'success');
            } catch (error) {
                console.error('Error refreshing medical history:', error);
                showMessage('Error refreshing medical history: ' + error.message, 'error');
            }
        }

        function clearBrowserCache() {
            try {
                // Clear localStorage
                localStorage.clear();
                
                // Clear sessionStorage
                sessionStorage.clear();
                
                // Force page reload
                window.location.reload(true);
            } catch (error) {
                console.error('Error clearing browser cache:', error);
            }
        }

        async function testViewDownload() {
            try {
                console.log('🧪 Testing View/Download functionality...');
                
                if (medicalHistory.length === 0) {
                    alert('No documents in medical history to test. Please upload a file first.');
                    return;
                }
                
                // Find a document with a valid ID
                const validDoc = medicalHistory.find(doc => {
                    const docId = doc.id;
                    return docId && docId !== 'null' && docId !== 'undefined';
                });
                
                if (!validDoc) {
                    alert('No valid documents found to test. All documents have missing IDs.');
                    return;
                }
                
                console.log('🧪 Testing with document:', validDoc.filename, 'ID:', validDoc.id);
                
                // Test the viewFile function
                console.log('🧪 Testing viewFile function...');
                await viewFile(validDoc.id);
                
                // Wait a bit then test download
                setTimeout(async () => {
                    console.log('🧪 Testing downloadFile function...');
                    await downloadFile(validDoc.id, validDoc.filename);
                }, 2000);
                
            } catch (error) {
                console.error('❌ Test error:', error);
                alert('Test failed: ' + error.message);
            }
        }

        // Test API connection on page load
        window.addEventListener('load', async function() {
            try {
                console.log('🚀 Page loaded, testing API connection...');
                const response = await fetch('http://localhost:8000/health');
                if (response.ok) {
                    console.log('✅ API is accessible');
                    // Load medical history on page load
                    await loadMedicalHistory();
                    console.log('✅ Medical history loaded on page load');
                } else {
                    console.log('❌ API health check failed');
                }
            } catch (error) {
                console.log('❌ API is not accessible:', error.message);
            }
        });

        // Add global error handler
        window.addEventListener('error', function(e) {
            console.error('🚨 JavaScript Error:', e.error);
            console.error('🚨 Error details:', e.message, 'at', e.filename, 'line', e.lineno);
        });
    </script>
</body>
</html>
