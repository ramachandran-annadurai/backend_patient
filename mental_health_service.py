#!/usr/bin/env python3
"""
Mental Health Service for Patient Alert System
Direct integration of Mental Health module
"""

import os
import random
import json
import requests
import io
from datetime import datetime
from typing import List, Dict, Any, Optional
import openai
from dotenv import load_dotenv
from pymongo import MongoClient

# Load environment variables
load_dotenv()

class MentalHealthService:
    """Mental Health Service for story generation and assessment"""
    
    def __init__(self):
        """Initialize the Mental Health Service"""
        self.openai_client = None
        self.elevenlabs_api_key = os.getenv("ELEVENLABS_API_KEY")
        
        # Initialize database connection (use same as main app)
        try:
            mongo_uri = os.getenv("MONGO_URI", "mongodb://localhost:27017")
            db_name = os.getenv("DB_NAME", "patients_db")
            self.mongo_client = MongoClient(mongo_uri)
            self.db = self.mongo_client[db_name]
            self.mental_health_collection = self.db.mental_health_assessments
            print(f"тЬЕ Mental Health Service: Database connected successfully to {mongo_uri}/{db_name}")
            print(f"тЬЕ Mental Health Service: Collection: mental_health_assessments")
        except Exception as e:
            print(f"тЭМ Mental Health Service: Database connection failed: {e}")
            self.mongo_client = None
            self.db = None
            self.mental_health_collection = None
        
        # Initialize OpenAI client
        try:
            openai_api_key = os.getenv("OPENAI_API_KEY")
            if openai_api_key and openai_api_key != "your_openai_api_key_here":
                self.openai_client = openai.OpenAI(api_key=openai_api_key)
                print("тЬЕ Mental Health OpenAI client initialized")
            else:
                print("тЪая╕П OpenAI API key not found, using fallback mode")
        except Exception as e:
            print(f"тЪая╕П OpenAI initialization failed: {e}")
        
        # Story templates for different scenarios
        self.story_templates = {
            "pregnancy": [
                "роТро░рпБ роЪро┐ро▒ро┐роп роХро┐ро░ро╛роородрпНродро┐ро▓рпН ро╡ро╛ро┤рпБроорпН рокрпЖрогрпН роЪроорпВроХ рокро┐ро░роЪрпНроЪро┐ройрпИроХро│рпИ роЪрооро╛ро│ро┐роХрпНроХрпБроорпН роХродрпИ",
                "роТро░рпБ рокрпЖрогрпН родройродрпБ роХрпБроЯрпБроорпНрокродрпНродрпБроЯройрпН роТро▒рпНро▒рпБроорпИропрпИ ро╡ро│ро░рпНроХрпНроХрпБроорпН роХродрпИ",
                "роТро░рпБ рокрпЖрогрпН родройродрпБ рокропродрпНродрпИ ро╡рпЖройрпНро▒рпБ родрпИро░ро┐ропроорпН рокрпЖро▒рпБроорпН роХродрпИ",
                "роТро░рпБ рокрпЖрогрпН роЪроорпВроХродрпНродро┐ро▓рпН рооро╛ро▒рпНро▒родрпНродрпИ роХрпКрогрпНроЯрпБ ро╡ро░рпБроорпН роХродрпИ",
                "роТро░рпБ рокрпЖрогрпН родройродрпБ роХройро╡рпБроХро│рпИ роиро┐ро▒рпИро╡рпЗро▒рпНро▒рпБроорпН роХродрпИ",
                "роТро░рпБ рокрпЖрогрпН роХрпБроЯрпБроорпНрокродрпНродро┐ройрпН роЖродро░ро╡рпБроЯройрпН роЪро╡ро╛ро▓рпНроХро│рпИ роЪрооро╛ро│ро┐роХрпНроХрпБроорпН роХродрпИ",
                "роТро░рпБ рокрпЖрогрпН роЪроорпВроХ роТро▒рпНро▒рпБроорпИропрпИ ро╡ро│ро░рпНроХрпНроХрпБроорпН роХродрпИ"
            ],
            "postpartum": [
                "рокрпБродро┐роп родро╛ропрпН родрпВроХрпНроХроорпН роЗро┤рокрпНрокрпБ рооро▒рпНро▒рпБроорпН роЕродро┐роХрооро╛рой рокрпКро▒рпБрокрпНрокрпБроХро│рпИ роЪрооро╛ро│ро┐роХрпНроХрпБроорпН роХродрпИ",
                "рокрпБродро┐роп родро╛ропрпН роХрпБро┤роирпНродрпИропрпБроЯройро╛рой родрпКроЯро░рпНрокрпБ роЗро┤рокрпНрокрпБ рооро▒рпНро▒рпБроорпН родро┐ро▒роорпИ роХрпЗро│рпНро╡ро┐роХро│рпН рокро▒рпНро▒ро┐роп роХродрпИ",
                "рокрпБродро┐роп родро╛ропрпН роЪроорпВроХ родройро┐роорпИ рооро▒рпНро▒рпБроорпН роЕроЯрпИропро╛ро│ роЗро┤рокрпНрокрпБ рокро▒рпНро▒ро┐роп роХродрпИ",
                "рокрпБродро┐роп родро╛ропрпН роХрпБро┤роирпНродрпИ роЖро░рпЛроХрпНроХро┐ропроорпН рооро▒рпНро▒рпБроорпН ро╡ро│ро░рпНроЪрпНроЪро┐ рокро▒рпНро▒ро┐роп роХро╡ро▓рпИ рокро▒рпНро▒ро┐роп роХродрпИ",
                "рокрпБродро┐роп родро╛ропрпН роХрогро╡ро░рпН роЙро▒ро╡рпБ рооро╛ро▒рпНро▒роЩрпНроХро│рпН рооро▒рпНро▒рпБроорпН роЖродро░ро╡рпБ родрпЗро╡рпИроХро│рпН рокро▒рпНро▒ро┐роп роХродрпИ"
            ],
            "general": [
                "ро╡рпЗро▓рпИ-ро╡ро╛ро┤рпНроХрпНроХрпИ роЪроороиро┐ро▓рпИ рооро▒рпНро▒рпБроорпН роЕро┤рпБродрпНрод роорпЗро▓ро╛рогрпНроорпИ рокро▒рпНро▒ро┐роп роХродрпИ",
                "роЪроорпВроХ рокропроорпН рооро▒рпНро▒рпБроорпН роЙро▒ро╡рпБ роХроЯрпНроЯроорпИродрпНродро▓рпН рокро▒рпНро▒ро┐роп роХродрпИ",
                "родрпБропро░роорпН рооро▒рпНро▒рпБроорпН роЗро┤рокрпНрокрпБ роЕройрпБрокро╡ро┐роХрпНроХрпБроорпН роХродрпИ",
                "роиро┐родро┐ роЕро┤рпБродрпНродроорпН рооро▒рпНро▒рпБроорпН роОродро┐ро░рпНроХро╛ро▓ роиро┐роЪрпНроЪропрооро▒рпНро▒ родройрпНроорпИ рокро▒рпНро▒ро┐роп роХродрпИ",
                "роЪрпБроп роородро┐рокрпНрокрпБ рооро▒рпНро▒рпБроорпН родройро┐рокрпНрокроЯрпНроЯ ро╡ро│ро░рпНроЪрпНроЪро┐ рокро▒рпНро▒ро┐роп роХродрпИ"
            ]
        }
        
        # Complete story templates for pregnancy mental health
        self.complete_stories = [
            {
                "title": "роТро▒рпНро▒рпБроорпИропро┐ройрпН ро╡ро▓ро┐роорпИ",
                "content": "роорпАройро╛ роТро░рпБ роЪро┐ро▒ро┐роп роХро┐ро░ро╛роородрпНродро┐ро▓рпН ро╡ро╛ро┤рпНроирпНродро╛ро│рпН. роЕро╡ро│рпБроХрпНроХрпБ рооро┐роХро╡рпБроорпН роХро╡ро▓рпИ рооро▒рпНро▒рпБроорпН рокропроорпН. \"роиро╛ройрпН роОрокрпНрокроЯро┐ роЗроирпНрод роЪро╡ро╛ро▓рпНроХро│рпИ роЪрооро╛ро│ро┐рокрпНрокрпЗройрпН?\" роОройрпНро▒рпБ роОрокрпНрокрпЛродрпБроорпН роЪро┐роирпНродро┐роХрпНроХро┐ро▒ро╛ро│рпН. роТро░рпБ роиро╛ро│рпН, роЕро╡ро│родрпБ роХро┐ро░ро╛роородрпНродро┐ро▓рпН рокрпЖро░ро┐роп рокро┐ро░роЪрпНроЪро┐ройрпИ ро╡роирпНродродрпБ. роЕройрпИро╡ро░рпБроорпН родройро┐родрпНродройро┐ропро╛роХ роЪрооро╛ро│ро┐роХрпНроХ роорпБропро▒рпНроЪро┐родрпНродройро░рпН, роЖройро╛ро▓рпН роОродрпБро╡рпБроорпН роироЯроХрпНроХро╡ро┐ро▓рпНро▓рпИ. роЕрокрпНрокрпЛродрпБ роорпАройро╛ роЙрогро░рпНроирпНродро╛ро│рпН - родройро┐роорпИропро┐ро▓рпН рокропроорпН, роЖройро╛ро▓рпН роТро▒рпНро▒рпБроорпИропро┐ро▓рпН ро╡ро▓ро┐роорпИ! роЕро╡ро│рпН роЕройрпИро╡ро░рпИропрпБроорпН роТройрпНро▒ро╛роХ роЪрпЗро░рпНродрпНродро╛ро│рпН. \"роиро╛роорпН роТройрпНро▒ро╛роХ роЗро░рпБроирпНродро╛ро▓рпН роОроирпНрод рокро┐ро░роЪрпНроЪро┐ройрпИропрпИропрпБроорпН родрпАро░рпНроХрпНроХ роорпБроЯро┐ропрпБроорпН\" роОройрпНро▒рпБ роХрпВро▒ро┐ройро╛ро│рпН. роХро┐ро░ро╛роородрпНродро╛ро░рпН роЕройрпИро╡ро░рпБроорпН роТройрпНро▒ро╛роХ роЪрпЗро░рпНроирпНродрпБ рокро┐ро░роЪрпНроЪро┐ройрпИропрпИ родрпАро░рпНродрпНродройро░рпН. роЕрокрпНрокрпЛродрпБ роорпАройро╛ роЙрогро░рпНроирпНродро╛ро│рпН - роХрпБроЯрпБроорпНрокроорпН рооро▒рпНро▒рпБроорпН роЪроорпВроХродрпНродро┐ройрпН роЖродро░ро╡рпБ роОроирпНрод рокро┐ро░роЪрпНроЪро┐ройрпИропрпИропрпБроорпН родрпАро░рпНроХрпНроХ роорпБроЯро┐ропрпБроорпН. роТро▒рпНро▒рпБроорпИропро┐ро▓рпН рооро┐роХрокрпНрокрпЖро░ро┐роп ро╡ро▓ро┐роорпИ роЗро░рпБроХрпНроХро┐ро▒родрпБ. роЗродро┐ро▓ро┐ро░рпБроирпНродрпБ роиро╛роорпН роХро▒рпНро▒рпБроХрпНроХрпКро│рпНро│рпБроорпН рокро╛роЯроорпН: \"роТро▒рпНро▒рпБроорпИ ро╡ро▓ро┐роорпИ\" - роиро╛роорпН роТройрпНро▒ро╛роХ роЗро░рпБроирпНродро╛ро▓рпН роОроирпНрод роЪро╡ро╛ро▓рпИропрпБроорпН роЪрооро╛ро│ро┐роХрпНроХ роорпБроЯро┐ропрпБроорпН."
            },
            {
                "title": "рокрпКро▒рпБроорпИропро┐ройрпН ро╡ро▓ро┐роорпИ",
                "content": "роХро▓рпНропро╛рогро┐ роТро░рпБ роЪро┐ро▒ро┐роп роХро┐ро░ро╛роородрпНродро┐ро▓рпН ро╡ро╛ро┤рпНроирпНродро╛ро│рпН. роЕро╡ро│рпБроХрпНроХрпБ рооро┐роХро╡рпБроорпН роХрпЛрокроорпН рооро▒рпНро▒рпБроорпН роОро░ро┐роЪрпНроЪро▓рпН. \"роОро▓рпНро▓ро╛роорпН роОройроХрпНроХрпБ роОродро┐ро░ро╛роХро╡рпЗ роЗро░рпБроХрпНроХро┐ро▒родрпБ\" роОройрпНро▒рпБ роОрокрпНрокрпЛродрпБроорпН роЪро┐роирпНродро┐роХрпНроХро┐ро▒ро╛ро│рпН. роТро░рпБ роиро╛ро│рпН, роЕро╡ро│родрпБ роХро┐ро░ро╛роородрпНродро┐ро▓рпН рокрпЖро░ро┐роп рокро┐ро░роЪрпНроЪро┐ройрпИ ро╡роирпНродродрпБ. роЕройрпИро╡ро░рпБроорпН роХрпЛрокрооро╛роХро╡рпБроорпН роОро░ро┐роЪрпНроЪро▓ро╛роХро╡рпБроорпН роЗро░рпБроирпНродройро░рпН. роЕрокрпНрокрпЛродрпБ роХро▓рпНропро╛рогро┐ роЙрогро░рпНроирпНродро╛ро│рпН - роХрпЛрокродрпНродро┐ро▓рпН рокро┐ро░роЪрпНроЪро┐ройрпИ, роЖройро╛ро▓рпН рокрпКро▒рпБроорпИропро┐ро▓рпН родрпАро░рпНро╡рпБ! роЕро╡ро│рпН роЕройрпИро╡ро░рпИропрпБроорпН роЕроорпИродро┐ропро╛роХ роЗро░рпБроХрпНроХроЪрпН роЪрпЖропрпНродро╛ро│рпН. \"рокрпКро▒рпБроорпИропрпБроЯройрпН роЪро┐роирпНродро┐родрпНродро╛ро▓рпН роОроирпНрод рокро┐ро░роЪрпНроЪро┐ройрпИропрпИропрпБроорпН родрпАро░рпНроХрпНроХ роорпБроЯро┐ропрпБроорпН\" роОройрпНро▒рпБ роХрпВро▒ро┐ройро╛ро│рпН. роХро┐ро░ро╛роородрпНродро╛ро░рпН роЕройрпИро╡ро░рпБроорпН рокрпКро▒рпБроорпИропрпБроЯройрпН роЪро┐роирпНродро┐родрпНродрпБ рокро┐ро░роЪрпНроЪро┐ройрпИропрпИ родрпАро░рпНродрпНродройро░рпН. роЕрокрпНрокрпЛродрпБ роХро▓рпНропро╛рогро┐ роЙрогро░рпНроирпНродро╛ро│рпН - рокрпКро▒рпБроорпИ роОроирпНрод рокро┐ро░роЪрпНроЪро┐ройрпИропрпИропрпБроорпН родрпАро░рпНроХрпНроХ роорпБроЯро┐ропрпБроорпН. рокрпКро▒рпБроорпИропро┐ро▓рпН рооро┐роХрокрпНрокрпЖро░ро┐роп ро╡ро▓ро┐роорпИ роЗро░рпБроХрпНроХро┐ро▒родрпБ. роЗродро┐ро▓ро┐ро░рпБроирпНродрпБ роиро╛роорпН роХро▒рпНро▒рпБроХрпНроХрпКро│рпНро│рпБроорпН рокро╛роЯроорпН: \"рокрпКро▒рпБроорпИ роЕроорпИродро┐ родро░рпБроорпН\" - рокрпКро▒рпБроорпИропрпБроЯройрпН роЪро┐роирпНродро┐родрпНродро╛ро▓рпН роОроирпНрод роЪро╡ро╛ро▓рпИропрпБроорпН роЪрооро╛ро│ро┐роХрпНроХ роорпБроЯро┐ропрпБроорпН."
            },
            {
                "title": "роХрпБроЯрпБроорпНрок роЖродро░ро╡ро┐ройрпН ро╡ро▓ро┐роорпИ",
                "content": "рокро┐ро░ро┐ропро╛ роТро░рпБ роЪро┐ро▒ро┐роп роХро┐ро░ро╛роородрпНродро┐ро▓рпН ро╡ро╛ро┤рпНроирпНродро╛ро│рпН. роЕро╡ро│рпБроХрпНроХрпБ рооро┐роХро╡рпБроорпН родройро┐роорпИ рооро▒рпНро▒рпБроорпН роХро╡ро▓рпИ. \"роиро╛ройрпН ропро╛ро░рпБроХрпНроХрпБроорпН родрпЗро╡рпИропро┐ро▓рпНро▓рпИ\" роОройрпНро▒рпБ роОрокрпНрокрпЛродрпБроорпН роЪро┐роирпНродро┐роХрпНроХро┐ро▒ро╛ро│рпН. роТро░рпБ роиро╛ро│рпН, роЕро╡ро│родрпБ роХро┐ро░ро╛роородрпНродро┐ро▓рпН рокрпЖро░ро┐роп рокро┐ро░роЪрпНроЪро┐ройрпИ ро╡роирпНродродрпБ. роЕройрпИро╡ро░рпБроорпН родройро┐родрпНродройро┐ропро╛роХ роЪрооро╛ро│ро┐роХрпНроХ роорпБропро▒рпНроЪро┐родрпНродройро░рпН, роЖройро╛ро▓рпН роОродрпБро╡рпБроорпН роироЯроХрпНроХро╡ро┐ро▓рпНро▓рпИ. роЕрокрпНрокрпЛродрпБ рокро┐ро░ро┐ропро╛ роЙрогро░рпНроирпНродро╛ро│рпН - родройро┐роорпИропро┐ро▓рпН рокропроорпН, роЖройро╛ро▓рпН роХрпБроЯрпБроорпНрок роЖродро░ро╡ро┐ро▓рпН ро╡ро▓ро┐роорпИ! роЕро╡ро│рпН родройродрпБ роХрпБроЯрпБроорпНрокродрпНродро┐роЯроорпН роЖродро░ро╡рпБ роХрпЗроЯрпНроЯро╛ро│рпН. \"роиро╛роорпН роТройрпНро▒ро╛роХ роЗро░рпБроирпНродро╛ро▓рпН роОроирпНрод рокро┐ро░роЪрпНроЪро┐ройрпИропрпИропрпБроорпН родрпАро░рпНроХрпНроХ роорпБроЯро┐ропрпБроорпН\" роОройрпНро▒рпБ роХрпВро▒ро┐ройро╛ро│рпН. роХрпБроЯрпБроорпНрокроорпН роЕройрпИро╡ро░рпБроорпН роТройрпНро▒ро╛роХ роЪрпЗро░рпНроирпНродрпБ рокро┐ро░роЪрпНроЪро┐ройрпИропрпИ родрпАро░рпНродрпНродройро░рпН. роЕрокрпНрокрпЛродрпБ рокро┐ро░ро┐ропро╛ роЙрогро░рпНроирпНродро╛ро│рпН - роХрпБроЯрпБроорпНрок роЖродро░ро╡рпБ роОроирпНрод рокро┐ро░роЪрпНроЪро┐ройрпИропрпИропрпБроорпН родрпАро░рпНроХрпНроХ роорпБроЯро┐ропрпБроорпН. роХрпБроЯрпБроорпНрок роЖродро░ро╡ро┐ро▓рпН рооро┐роХрокрпНрокрпЖро░ро┐роп ро╡ро▓ро┐роорпИ роЗро░рпБроХрпНроХро┐ро▒родрпБ. роЗродро┐ро▓ро┐ро░рпБроирпНродрпБ роиро╛роорпН роХро▒рпНро▒рпБроХрпНроХрпКро│рпНро│рпБроорпН рокро╛роЯроорпН: \"роХрпБроЯрпБроорпНрок роЖродро░ро╡рпБ роОро▓рпНро▓ро╛роорпН\" - роХрпБроЯрпБроорпНрокроорпН роТройрпНро▒ро╛роХ роЗро░рпБроирпНродро╛ро▓рпН роОроирпНрод роЪро╡ро╛ро▓рпИропрпБроорпН роЪрооро╛ро│ро┐роХрпНроХ роорпБроЯро┐ропрпБроорпН."
            },
            {
                "title": "роироорпНрокро┐роХрпНроХрпИропро┐ройрпН ро╡ро▓ро┐роорпИ",
                "content": "ро░рпЗроХро╛ роТро░рпБ роЪро┐ро▒ро┐роп роХро┐ро░ро╛роородрпНродро┐ро▓рпН ро╡ро╛ро┤рпНроирпНродро╛ро│рпН. роЕро╡ро│рпБроХрпНроХрпБ рооро┐роХро╡рпБроорпН рокропроорпН рооро▒рпНро▒рпБроорпН роироорпНрокро┐роХрпНроХрпИ роЗро┤рокрпНрокрпБ. \"роОродрпБро╡рпБроорпН роироЯроХрпНроХро╛родрпБ\" роОройрпНро▒рпБ роОрокрпНрокрпЛродрпБроорпН роЪро┐роирпНродро┐роХрпНроХро┐ро▒ро╛ро│рпН. роТро░рпБ роиро╛ро│рпН, роЕро╡ро│родрпБ роХро┐ро░ро╛роородрпНродро┐ро▓рпН рокрпЖро░ро┐роп рокро┐ро░роЪрпНроЪро┐ройрпИ ро╡роирпНродродрпБ. роЕройрпИро╡ро░рпБроорпН рокропрооро╛роХро╡рпБроорпН роироорпНрокро┐роХрпНроХрпИ роЗро┤роирпНродро╡ро░рпНроХро│ро╛роХро╡рпБроорпН роЗро░рпБроирпНродройро░рпН. роЕрокрпНрокрпЛродрпБ ро░рпЗроХро╛ роЙрогро░рпНроирпНродро╛ро│рпН - рокропродрпНродро┐ро▓рпН родрпЛро▓рпНро╡ро┐, роЖройро╛ро▓рпН роироорпНрокро┐роХрпНроХрпИропро┐ро▓рпН ро╡рпЖро▒рпНро▒ро┐! роЕро╡ро│рпН роЕройрпИро╡ро░рпБроХрпНроХрпБроорпН роироорпНрокро┐роХрпНроХрпИ роЕро│ро┐родрпНродро╛ро│рпН. \"роироорпНрокро┐роХрпНроХрпИропрпБроЯройрпН роорпБропро▒рпНроЪро┐родрпНродро╛ро▓рпН роОроирпНрод рокро┐ро░роЪрпНроЪро┐ройрпИропрпИропрпБроорпН родрпАро░рпНроХрпНроХ роорпБроЯро┐ропрпБроорпН\" роОройрпНро▒рпБ роХрпВро▒ро┐ройро╛ро│рпН. роХро┐ро░ро╛роородрпНродро╛ро░рпН роЕройрпИро╡ро░рпБроорпН роироорпНрокро┐роХрпНроХрпИропрпБроЯройрпН роорпБропро▒рпНроЪро┐родрпНродрпБ рокро┐ро░роЪрпНроЪро┐ройрпИропрпИ родрпАро░рпНродрпНродройро░рпН. роЕрокрпНрокрпЛродрпБ ро░рпЗроХро╛ роЙрогро░рпНроирпНродро╛ро│рпН - роироорпНрокро┐роХрпНроХрпИ роОроирпНрод рокро┐ро░роЪрпНроЪро┐ройрпИропрпИропрпБроорпН родрпАро░рпНроХрпНроХ роорпБроЯро┐ропрпБроорпН. роироорпНрокро┐роХрпНроХрпИропро┐ро▓рпН рооро┐роХрокрпНрокрпЖро░ро┐роп ро╡ро▓ро┐роорпИ роЗро░рпБроХрпНроХро┐ро▒родрпБ. роЗродро┐ро▓ро┐ро░рпБроирпНродрпБ роиро╛роорпН роХро▒рпНро▒рпБроХрпНроХрпКро│рпНро│рпБроорпН рокро╛роЯроорпН: \"роироорпНрокро┐роХрпНроХрпИ рокропродрпНродрпИ ро╡рпЖро▓рпНроХро┐ро▒родрпБ\" - роироорпНрокро┐роХрпНроХрпИропрпБроЯройрпН роорпБропро▒рпНроЪро┐родрпНродро╛ро▓рпН роОроирпНрод роЪро╡ро╛ро▓рпИропрпБроорпН роЪрооро╛ро│ро┐роХрпНроХ роорпБроЯро┐ропрпБроорпН."
            },
            {
                "title": "родрпИро░ро┐ропродрпНродро┐ройрпН ро╡ро▓ро┐роорпИ",
                "content": "роЪрпБроородро┐ роТро░рпБ роЪро┐ро▒ро┐роп роХро┐ро░ро╛роородрпНродро┐ро▓рпН ро╡ро╛ро┤рпНроирпНродро╛ро│рпН. роЕро╡ро│рпБроХрпНроХрпБ рооро┐роХро╡рпБроорпН рокропроорпН рооро▒рпНро▒рпБроорпН родрпИро░ро┐ропроорпН роЗро┤рокрпНрокрпБ. \"роиро╛ройрпН роОродрпБро╡рпБроорпН роЪрпЖропрпНроп роорпБроЯро┐ропро╛родрпБ\" роОройрпНро▒рпБ роОрокрпНрокрпЛродрпБроорпН роЪро┐роирпНродро┐роХрпНроХро┐ро▒ро╛ро│рпН. роТро░рпБ роиро╛ро│рпН, роЕро╡ро│родрпБ роХро┐ро░ро╛роородрпНродро┐ро▓рпН рокрпЖро░ро┐роп рокро┐ро░роЪрпНроЪро┐ройрпИ ро╡роирпНродродрпБ. роЕройрпИро╡ро░рпБроорпН рокропрооро╛роХро╡рпБроорпН родрпИро░ро┐ропроорпН роЗро┤роирпНродро╡ро░рпНроХро│ро╛роХро╡рпБроорпН роЗро░рпБроирпНродройро░рпН. роЕрокрпНрокрпЛродрпБ роЪрпБроородро┐ роЙрогро░рпНроирпНродро╛ро│рпН - рокропродрпНродро┐ро▓рпН родрпЛро▓рпНро╡ро┐, роЖройро╛ро▓рпН родрпИро░ро┐ропродрпНродро┐ро▓рпН ро╡рпЖро▒рпНро▒ро┐! роЕро╡ро│рпН роЕройрпИро╡ро░рпБроХрпНроХрпБроорпН родрпИро░ро┐ропроорпН роЕро│ро┐родрпНродро╛ро│рпН. \"родрпИро░ро┐ропродрпНродрпБроЯройрпН роорпБропро▒рпНроЪро┐родрпНродро╛ро▓рпН роОроирпНрод рокро┐ро░роЪрпНроЪро┐ройрпИропрпИропрпБроорпН родрпАро░рпНроХрпНроХ роорпБроЯро┐ропрпБроорпН\" роОройрпНро▒рпБ роХрпВро▒ро┐ройро╛ро│рпН. роХро┐ро░ро╛роородрпНродро╛ро░рпН роЕройрпИро╡ро░рпБроорпН родрпИро░ро┐ропродрпНродрпБроЯройрпН роорпБропро▒рпНроЪро┐родрпНродрпБ рокро┐ро░роЪрпНроЪро┐ройрпИропрпИ родрпАро░рпНродрпНродройро░рпН. роЕрокрпНрокрпЛродрпБ роЪрпБроородро┐ роЙрогро░рпНроирпНродро╛ро│рпН - родрпИро░ро┐ропроорпН роОроирпНрод рокро┐ро░роЪрпНроЪро┐ройрпИропрпИропрпБроорпН родрпАро░рпНроХрпНроХ роорпБроЯро┐ропрпБроорпН. родрпИро░ро┐ропродрпНродро┐ро▓рпН рооро┐роХрокрпНрокрпЖро░ро┐роп ро╡ро▓ро┐роорпИ роЗро░рпБроХрпНроХро┐ро▒родрпБ. роЗродро┐ро▓ро┐ро░рпБроирпНродрпБ роиро╛роорпН роХро▒рпНро▒рпБроХрпНроХрпКро│рпНро│рпБроорпН рокро╛роЯроорпН: \"родрпИро░ро┐ропроорпН роЪро╡ро╛ро▓рпНроХро│ро┐ро▓рпН ро╡ро│ро░рпНроХро┐ро▒родрпБ\" - родрпИро░ро┐ропродрпНродрпБроЯройрпН роорпБропро▒рпНроЪро┐родрпНродро╛ро▓рпН роОроирпНрод роЪро╡ро╛ро▓рпИропрпБроорпН роЪрооро╛ро│ро┐роХрпНроХ роорпБроЯро┐ропрпБроорпН."
            }
        ]
        
        # Question templates in Tamil
        self.question_templates = [
            {
                "question": "{character_name} роЗрокрпНрокрпЛродрпБ роОрокрпНрокроЯро┐ роЙрогро░рпБроХро┐ро▒ро╛ро░рпН роОройрпНро▒рпБ роиро┐ройрпИроХрпНроХро┐ро▒рпАро░рпНроХро│рпН?",
                "options": [
                    "рооро┐роХро╡рпБроорпН роЕро┤рпБродрпНродрооро╛роХро╡рпБроорпН роХро╡ро▓рпИропро╛роХро╡рпБроорпН",
                    "ро╡ро░рпБродрпНродрооро╛роХро╡рпБроорпН рооройроЪрпНроЪрпЛро░рпНро╡ро╛роХро╡рпБроорпН",
                    "роЗроирпНрод роЪрпВро┤рпНроиро┐ро▓рпИроХрпНроХрпБ роЪро╛родро╛ро░рог роЙрогро░рпНро╡рпБроХро│рпН",
                    "роЙро▒рпНроЪро╛роХрооро╛роХро╡рпБроорпН роироорпНрокро┐роХрпНроХрпИропро╛роХро╡рпБроорпН"
                ]
            },
            {
                "question": "роирпАроЩрпНроХро│рпН {character_name} роиро┐ро▓рпИропро┐ро▓рпН роЗро░рпБроирпНродро╛ро▓рпН роОройрпНрой роЪрпЖропрпНро╡рпАро░рпНроХро│рпН?",
                "options": [
                    "родрпКро┤ро┐ро▓рпНроорпБро▒рпИ роЙродро╡ро┐ роЕро▓рпНро▓родрпБ роЖро▓рпЛроЪройрпИ родрпЗроЯрпБро╡рпЗройрпН",
                    "родройро┐ропро╛роХ роЪрооро╛ро│ро┐роХрпНроХ роорпБропро▒рпНроЪро┐рокрпНрокрпЗройрпН",
                    "роХрпБроЯрпБроорпНрокроорпН рооро▒рпНро▒рпБроорпН роирогрпНрокро░рпНроХро│ро┐роЯроорпН роЖродро░ро╡рпБ роХрпЗроЯрпНрокрпЗройрпН",
                    "роУропрпНро╡рпБ роОроЯрпБродрпНродрпБ роЪрпБроп рокро░ро╛рооро░ро┐рокрпНрокро┐ро▓рпН роХро╡ройроорпН роЪрпЖро▓рпБродрпНродрпБро╡рпЗройрпН"
                ]
            },
            {
                "question": "{character_name} роЙрогро░рпНро╡рпБроХро│рпН роЪро╛родро╛ро░рогрооро╛ройро╡рпИ роОройрпНро▒рпБ роиро┐ройрпИроХрпНроХро┐ро▒рпАро░рпНроХро│ро╛?",
                "options": [
                    "роЖроорпН, роорпБро▒рпНро▒ро┐ро▓рпБроорпН роЪро╛родро╛ро░рогроорпН",
                    "роУро░ро│ро╡рпБ роЪро╛родро╛ро░рогроорпН",
                    "рооро┐роХро╡рпБроорпН роЪро╛родро╛ро░рогрооро▓рпНро▓",
                    "роЪро╛родро╛ро░рогрооро▓рпНро▓"
                ]
            },
            {
                "question": "{character_name}роХрпНроХрпБ роОройрпНрой роЖро▓рпЛроЪройрпИ родро░рпБро╡рпАро░рпНроХро│рпН?",
                "options": [
                    "родрпКро┤ро┐ро▓рпНроорпБро▒рпИ роорой роЖро░рпЛроХрпНроХро┐роп роЖродро░ро╡рпБ родрпЗроЯрпБроЩрпНроХро│рпН",
                    "роУропрпНро╡рпБ рооро▒рпНро▒рпБроорпН рооройроиро┐ро▓рпИ роирпБроЯрпНрокроЩрпНроХро│рпИ роорпБропро▒рпНроЪро┐роХрпНроХро╡рпБроорпН",
                    "роироорпНрокроХрооро╛рой роирогрпНрокро░рпНроХро│рпН роЕро▓рпНро▓родрпБ роХрпБроЯрпБроорпНрокродрпНродрпБроЯройрпН рокрпЗроЪрпБроЩрпНроХро│рпН",
                    "роХро╛родрпНродро┐ро░рпБроЩрпНроХро│рпН, роЗропро▒рпНроХрпИропро╛роХ роХроЯроирпНродрпБро╡ро┐роЯрпБроорпН"
                ]
            },
            {
                "question": "роЙроЩрпНроХро│рпН ро╡ро╛ро┤рпНроХрпНроХрпИропро┐ро▓рпН роЗродрпЗрокрпЛройрпНро▒ роЙрогро░рпНро╡рпБроХро│рпИ роЕройрпБрокро╡ро┐родрпНродро┐ро░рпБроХрпНроХро┐ро▒рпАро░рпНроХро│ро╛?",
                "options": [
                    "роЖроорпН, рооро┐роХро╡рпБроорпН роТродрпНрод роЕройрпБрокро╡роЩрпНроХро│рпН",
                    "роУро░ро│ро╡рпБ роТродрпНрод роЕройрпБрокро╡роЩрпНроХро│рпН",
                    "роХрпКроЮрпНроЪроорпН роТродрпНродро╡рпИ",
                    "роТродрпНродро╡рпИ роЗро▓рпНро▓рпИ"
                ]
            }
        ]
        
        print("тЬЕ Mental Health Service initialized successfully")
    
    def generate_story(self, story_type: str = "pregnancy", scenario: str = "pregnancy_mental_health") -> Dict[str, Any]:
        """Generate a mental health assessment story"""
        try:
            if scenario == "pregnancy_mental_health":
                # Use complete story templates
                selected_story = random.choice(self.complete_stories)
                
                # Generate questions based on the story
                questions = [
                    {
                        "question": f"{selected_story['title']} роХродрпИропро┐ро▓рпН роорпБроХрпНроХро┐роп рокро╛родрпНродро┐ро░роорпН ропро╛ро░рпН?",
                        "options": ["роорпАройро╛", "роХро▓рпНропро╛рогро┐", "рокро┐ро░ро┐ропро╛", "ро░рпЗроХро╛", "роЪрпБроородро┐"],
                        "correct_answer": 0
                    },
                    {
                        "question": "роХродрпИропро┐ро▓рпН роорпБроХрпНроХро┐роп рокро┐ро░роЪрпНроЪро┐ройрпИ роОройрпНрой?",
                        "options": [
                            "роХро┐ро░ро╛роородрпНродро┐ро▓рпН рокрпЖро░ро┐роп рокро┐ро░роЪрпНроЪро┐ройрпИ", 
                            "родройро┐роорпИ рооро▒рпНро▒рпБроорпН роХро╡ро▓рпИ", 
                            "роХрпЛрокроорпН рооро▒рпНро▒рпБроорпН роОро░ро┐роЪрпНроЪро▓рпН", 
                            "рокропроорпН рооро▒рпНро▒рпБроорпН роироорпНрокро┐роХрпНроХрпИ роЗро┤рокрпНрокрпБ"
                        ],
                        "correct_answer": 0
                    },
                    {
                        "question": "роХродрпИропро┐ройрпН роорпБроХрпНроХро┐роп рокро╛роЯроорпН роОройрпНрой?",
                        "options": [
                            "роТро▒рпНро▒рпБроорпИ ро╡ро▓ро┐роорпИ", 
                            "рокрпКро▒рпБроорпИ роЕроорпИродро┐ родро░рпБроорпН", 
                            "роХрпБроЯрпБроорпНрок роЖродро░ро╡рпБ роОро▓рпНро▓ро╛роорпН", 
                            "роироорпНрокро┐роХрпНроХрпИ рокропродрпНродрпИ ро╡рпЖро▓рпНроХро┐ро▒родрпБ"
                        ],
                        "correct_answer": 0
                    },
                    {
                        "question": "роХродрпИропро┐ро▓рпН рокро┐ро░роЪрпНроЪро┐ройрпИ роОрокрпНрокроЯро┐ родрпАро░рпНроирпНродродрпБ?",
                        "options": [
                            "роТройрпНро▒ро╛роХ роЪрпЗро░рпНроирпНродрпБ родрпАро░рпНродрпНродройро░рпН", 
                            "родройро┐родрпНродройро┐ропро╛роХ роЪрооро╛ро│ро┐родрпНродройро░рпН", 
                            "рооро░рпБродрпНродрпБро╡ро░ро┐ройрпН роЙродро╡ро┐ропрпБроЯройрпН", 
                            "роЕро░роЪро╛роЩрпНроХ роЙродро╡ро┐ропрпБроЯройрпН"
                        ],
                        "correct_answer": 0
                    },
                    {
                        "question": "роирпАроЩрпНроХро│рпН роЗродрпЗ роиро┐ро▓рпИропро┐ро▓рпН роЗро░рпБроирпНродро╛ро▓рпН роОройрпНрой роЪрпЖропрпНро╡рпАро░рпНроХро│рпН?",
                        "options": [
                            "роХрпБроЯрпБроорпНрокродрпНродро┐роЯроорпН роЖродро░ро╡рпБ роХрпЗроЯрпНрокрпЗройрпН", 
                            "родройро┐ропро╛роХ роЪрооро╛ро│ро┐роХрпНроХ роорпБропро▒рпНроЪро┐рокрпНрокрпЗройрпН", 
                            "рооро░рпБродрпНродрпБро╡ро░рпИ роЕрогрпБроХрпБро╡рпЗройрпН", 
                            "роУропрпНро╡рпБ роОроЯрпБродрпНродрпБ роЪро┐роирпНродро┐рокрпНрокрпЗройрпН"
                        ],
                        "correct_answer": 0
                    }
                ]
                
                return {
                    "story_id": f"story_{random.randint(1000, 9999)}",
                    "title": selected_story['title'],
                    "content": selected_story['content'],
                    "questions": questions,
                    "character_name": "роорпАройро╛",
                    "scenario": scenario,
                    "success": True
                }
            else:
                # Use OpenAI for other scenarios
                if not self.openai_client:
                    return self._get_fallback_story()
                
                scenarios = self.story_templates.get(story_type, self.story_templates["general"])
                selected_scenario = random.choice(scenarios)
                
                prompt = f"""
                Create a complete, meaningful story in Tamil about: {selected_scenario}
                
                Story Structure:
                1. BEGINNING: Introduce a pregnant woman character facing challenges
                2. MIDDLE: Show her struggles, emotions, and family dynamics
                3. END: Resolve with support and teach a moral lesson
                
                Requirements:
                - Write in Tamil language (родрооро┐ро┤ро┐ро▓рпН роОро┤рпБродрпБроЩрпНроХро│рпН)
                - Character name: Use a Tamil name like роорпАройро╛, роХро▓рпНропро╛рогро┐, рокро┐ро░ро┐ропро╛, etc.
                - Keep it between 200-300 words (detailed but focused)
                - Use warm, understanding tone
                - Include specific pregnancy concerns (fear, family pressure, body changes, future worries)
                - Show character's emotional journey and growth
                - Include family support, community help, or personal strength
                - End with clear moral lesson using phrase "роЗродро┐ро▓ро┐ро░рпБроирпНродрпБ роиро╛роорпН роХро▒рпНро▒рпБроХрпНроХрпКро│рпНро│рпБроорпН рокро╛роЯроорпН: [lesson]"
                
                Moral Lesson Examples:
                - "роТро▒рпНро▒рпБроорпИ ро╡ро▓ро┐роорпИ" (Unity is Strength)
                - "рокрпКро▒рпБроорпИ роЕроорпИродро┐ родро░рпБроорпН" (Patience brings Peace)
                - "роХрпБроЯрпБроорпНрок роЖродро░ро╡рпБ роОро▓рпНро▓ро╛роорпН" (Family Support is Everything)
                - "роироорпНрокро┐роХрпНроХрпИ рокропродрпНродрпИ ро╡рпЖро▓рпНроХро┐ро▒родрпБ" (Hope conquers Fear)
                - "роХро╛родро▓рпН роОро▓рпНро▓ро╛ро╡ро▒рпНро▒рпИропрпБроорпН ро╡рпЖро▓рпНроХро┐ро▒родрпБ" (Love overcomes All)
                - "родрпИро░ро┐ропроорпН роЪро╡ро╛ро▓рпНроХро│ро┐ро▓рпН ро╡ро│ро░рпНроХро┐ро▒родрпБ" (Courage grows with Challenges)
                
                Make it a complete story that teaches a valuable life lesson while helping assess mental health.
                """
                
                response = self.openai_client.chat.completions.create(
                    model="gpt-3.5-turbo",
                    messages=[
                        {"role": "system", "content": "You are a compassionate mental health counselor who creates engaging stories for assessment purposes."},
                        {"role": "user", "content": prompt}
                    ],
                    max_tokens=300,
                    temperature=0.8
                )
                
                story_content = response.choices[0].message.content.strip()
                
                # Generate character name (Tamil names)
                character_names = ["рокро┐ро░ро┐ропро╛", "роХро╡ро┐родро╛", "рооро╛ро▓родро┐", "ро░рпЗроХро╛", "роЪрпБроородро┐", "ро╡ро┐роЬропро╛", "ро▓роЯрпНроЪрпБрооро┐", "роХро╛роирпНродро┐", "роЪро░рпЛроЬро╛", "ро░ро╛роЬрпЗро╕рпНро╡ро░ро┐"]
                character_name = random.choice(character_names)
                
                # Generate story ID
                story_id = f"story_{random.randint(1000, 9999)}"
                
                # Generate title in Tamil
                title_prompt = f"Create a short, engaging title in Tamil (3-5 words) for this pregnancy story: {story_content[:100]}..."
                title_response = self.openai_client.chat.completions.create(
                    model="gpt-3.5-turbo",
                    messages=[
                        {"role": "user", "content": title_prompt}
                    ],
                    max_tokens=20,
                    temperature=0.7
                )
                title = title_response.choices[0].message.content.strip().replace('"', '')
                
                # Prepare questions with character name
                questions = []
                for template in self.question_templates:
                    question = {
                        "question": template["question"].format(character_name=character_name),
                        "options": template["options"]
                    }
                    questions.append(question)
                
                return {
                    "story_id": story_id,
                    "title": title,
                    "content": story_content,
                    "questions": questions,
                    "character_name": character_name,
                    "scenario": selected_scenario,
                    "success": True
                }
                
        except Exception as e:
            print(f"Error generating story: {e}")
            return self._get_fallback_story()
    
    def _get_fallback_story(self) -> Dict[str, Any]:
        """Get fallback story when OpenAI is not available"""
        selected_story = random.choice(self.complete_stories)
        
        questions = [
            {
                "question": f"{selected_story['title']} роХродрпИропро┐ро▓рпН роорпБроХрпНроХро┐роп рокро╛родрпНродро┐ро░роорпН ропро╛ро░рпН?",
                "options": ["роорпАройро╛", "роХро▓рпНропро╛рогро┐", "рокро┐ро░ро┐ропро╛", "ро░рпЗроХро╛", "роЪрпБроородро┐"],
                "correct_answer": 0
            },
            {
                "question": "роХродрпИропро┐ро▓рпН роорпБроХрпНроХро┐роп рокро┐ро░роЪрпНроЪро┐ройрпИ роОройрпНрой?",
                "options": [
                    "роХро┐ро░ро╛роородрпНродро┐ро▓рпН рокрпЖро░ро┐роп рокро┐ро░роЪрпНроЪро┐ройрпИ", 
                    "родройро┐роорпИ рооро▒рпНро▒рпБроорпН роХро╡ро▓рпИ", 
                    "роХрпЛрокроорпН рооро▒рпНро▒рпБроорпН роОро░ро┐роЪрпНроЪро▓рпН", 
                    "рокропроорпН рооро▒рпНро▒рпБроорпН роироорпНрокро┐роХрпНроХрпИ роЗро┤рокрпНрокрпБ"
                ],
                "correct_answer": 0
            },
            {
                "question": "роХродрпИропро┐ройрпН роорпБроХрпНроХро┐роп рокро╛роЯроорпН роОройрпНрой?",
                "options": [
                    "роТро▒рпНро▒рпБроорпИ ро╡ро▓ро┐роорпИ", 
                    "рокрпКро▒рпБроорпИ роЕроорпИродро┐ родро░рпБроорпН", 
                    "роХрпБроЯрпБроорпНрок роЖродро░ро╡рпБ роОро▓рпНро▓ро╛роорпН", 
                    "роироорпНрокро┐роХрпНроХрпИ рокропродрпНродрпИ ро╡рпЖро▓рпНроХро┐ро▒родрпБ"
                ],
                "correct_answer": 0
            },
            {
                "question": "роХродрпИропро┐ро▓рпН рокро┐ро░роЪрпНроЪро┐ройрпИ роОрокрпНрокроЯро┐ родрпАро░рпНроирпНродродрпБ?",
                "options": [
                    "роТройрпНро▒ро╛роХ роЪрпЗро░рпНроирпНродрпБ родрпАро░рпНродрпНродройро░рпН", 
                    "родройро┐родрпНродройро┐ропро╛роХ роЪрооро╛ро│ро┐родрпНродройро░рпН", 
                    "рооро░рпБродрпНродрпБро╡ро░ро┐ройрпН роЙродро╡ро┐ропрпБроЯройрпН", 
                    "роЕро░роЪро╛роЩрпНроХ роЙродро╡ро┐ропрпБроЯройрпН"
                ],
                "correct_answer": 0
            },
            {
                "question": "роирпАроЩрпНроХро│рпН роЗродрпЗ роиро┐ро▓рпИропро┐ро▓рпН роЗро░рпБроирпНродро╛ро▓рпН роОройрпНрой роЪрпЖропрпНро╡рпАро░рпНроХро│рпН?",
                "options": [
                    "роХрпБроЯрпБроорпНрокродрпНродро┐роЯроорпН роЖродро░ро╡рпБ роХрпЗроЯрпНрокрпЗройрпН", 
                    "родройро┐ропро╛роХ роЪрооро╛ро│ро┐роХрпНроХ роорпБропро▒рпНроЪро┐рокрпНрокрпЗройрпН", 
                    "рооро░рпБродрпНродрпБро╡ро░рпИ роЕрогрпБроХрпБро╡рпЗройрпН", 
                    "роУропрпНро╡рпБ роОроЯрпБродрпНродрпБ роЪро┐роирпНродро┐рокрпНрокрпЗройрпН"
                ],
                "correct_answer": 0
            }
        ]
        
        return {
            "story_id": f"story_{random.randint(1000, 9999)}",
            "title": selected_story['title'],
            "content": selected_story['content'],
            "questions": questions,
            "character_name": "роорпАройро╛",
            "scenario": "pregnancy_mental_health",
            "success": True
        }
    
    def assess_mental_health(self, answers: List[str], story_id: str, patient_id: str = None) -> Dict[str, Any]:
        """Analyze the assessment answers and provide mental health insights"""
        try:
            print(f"ЁЯФН Mental Health Assessment - Received answers: {answers}")
            print(f"ЁЯФН Mental Health Assessment - Story ID: {story_id}")
            
            # Validate answers
            if not answers or len(answers) == 0:
                return {
                    "success": False,
                    "error": "No answers provided"
                }
            
            # Convert string answers to numeric scores
            # Map answer options to scores (0-4 scale)
            answer_scores = []
            for answer in answers:
                if answer in ['Very positive', 'Very well', 'Very high', 'Not at all', 'Very confident']:
                    answer_scores.append(4)
                elif answer in ['Positive', 'Well', 'High', 'Slightly', 'Confident']:
                    answer_scores.append(3)
                elif answer in ['Neutral', 'Okay', 'Moderate', 'Moderately', 'Somewhat confident']:
                    answer_scores.append(2)
                elif answer in ['Negative', 'Poorly', 'Low', 'Very', 'Not very confident']:
                    answer_scores.append(1)
                elif answer in ['Very negative', 'Very poorly', 'Very low', 'Extremely', 'Not confident at all']:
                    answer_scores.append(0)
                else:
                    # Default to neutral score for unknown answers
                    answer_scores.append(2)
            
            # Calculate basic score
            total_score = sum(answer_scores)
            max_score = len(answer_scores) * 4
            percentage = (total_score / max_score) * 100
            
            print(f"ЁЯФН Mental Health Assessment - Answer scores: {answer_scores}")
            print(f"ЁЯФН Mental Health Assessment - Total score: {total_score}, Max score: {max_score}, Percentage: {percentage}")
            
            # Determine risk level with more nuanced scoring
            if percentage <= 25:
                risk_level = "Low Risk"
                risk_class = "risk-low"
                color = "#28a745"
                confidence = 85
            elif percentage <= 50:
                risk_level = "Mild Risk"
                risk_class = "risk-mild"
                color = "#17a2b8"
                confidence = 80
            elif percentage <= 70:
                risk_level = "Medium Risk"
                risk_class = "risk-medium"
                color = "#ffc107"
                confidence = 75
            elif percentage <= 85:
                risk_level = "High Risk"
                risk_class = "risk-high"
                color = "#fd7e14"
                confidence = 80
            else:
                risk_level = "Very High Risk"
                risk_class = "risk-very-high"
                color = "#dc3545"
                confidence = 85
            
            # Generate comprehensive analysis using OpenAI
            detailed_analysis = self._generate_analysis(risk_level, percentage, answer_scores)
            
            # Generate specific recommendations
            recommendations = self._generate_recommendations(risk_level, percentage, answer_scores)
            
            # Generate action plan
            action_plan = self._generate_action_plan(risk_level, percentage)
            
            # Prepare assessment data
            assessment_data = {
                "success": True,
                "story_id": story_id,
                "total_score": total_score,
                "max_score": max_score,
                "percentage": round(percentage, 1),
                "risk_level": risk_level,
                "risk_class": risk_class,
                "color": color,
                "confidence": confidence,
                "detailed_analysis": detailed_analysis,
                "recommendations": recommendations,
                "action_plan": action_plan,
                "answers": answers,
                "timestamp": datetime.now().isoformat()
            }
            
            # Save to database if available
            try:
                if self.mental_health_collection is not None:
                    assessment_record = {
                        "patient_id": patient_id or "unknown_patient",
                        "type": "mental_health_assessment",
                        "story_id": story_id,
                        "answers": answers,
                        "assessment_result": assessment_data,
                        "created_at": datetime.now(),
                        "status": "completed"
                    }
                    result = self.mental_health_collection.insert_one(assessment_record)
                    print(f"тЬЕ Mental health assessment saved to database with ID: {result.inserted_id}")
                    print(f"тЬЕ Database: {self.db.name}, Collection: {self.mental_health_collection.name}")
                    print(f"тЬЕ Patient ID: {patient_id or 'unknown_patient'}")
                    
                    # Verify the data was saved by counting documents
                    count = self.mental_health_collection.count_documents({"patient_id": patient_id or "unknown_patient"})
                    print(f"тЬЕ Total assessments for this patient: {count}")
                else:
                    print("тЪая╕П Database not available, assessment not saved")
            except Exception as db_error:
                print(f"тЭМ Database save error: {db_error}")
                # Don't fail the assessment if database save fails
            
            return assessment_data
            
        except Exception as e:
            print(f"Assessment error: {e}")
            return {
                "success": False,
                "error": f"Error assessing mental health: {str(e)}"
            }
    
    def _generate_analysis(self, risk_level: str, percentage: float, answers: List[int]) -> str:
        """Generate detailed analysis using OpenAI or fallback"""
        try:
            if not self.openai_client:
                return self._get_fallback_analysis(risk_level)
            
            analysis_prompt = f"""
            You are a specialized mental health counselor for pregnant women. Analyze these assessment responses:
            
            Answers: {answers}
            Total Score: {sum(answers)}/{len(answers) * 4} ({percentage:.1f}%)
            Risk Level: {risk_level}
            
            Provide a comprehensive analysis in Tamil language including:
            
            1. DETAILED ANALYSIS (2-3 sentences):
               - What these responses indicate about mental health during pregnancy
               - Specific concerns or strengths identified
               - Cultural context for Tamil-speaking pregnant women
            
            2. PERSONALIZED RECOMMENDATIONS (3-4 specific points):
               - Immediate coping strategies
               - When to seek professional help
               - Self-care practices for pregnancy
               - Family support suggestions
               - Cultural considerations
            
            3. PROFESSIONAL GUIDANCE (1-2 sentences):
               - Specific next steps for mental health support
               - Resources available in Tamil community
            
            Be warm, encouraging, culturally sensitive, and practical. Write in clear Tamil.
            Focus on pregnancy-specific mental health needs.
            """
            
            analysis_response = self.openai_client.chat.completions.create(
                model="gpt-3.5-turbo",
                messages=[
                    {"role": "system", "content": "You are a compassionate, culturally-sensitive mental health counselor specializing in pregnancy mental health for Tamil-speaking women. Provide detailed, practical, and encouraging guidance."},
                    {"role": "user", "content": analysis_prompt}
                ],
                max_tokens=500,
                temperature=0.7
            )
            return analysis_response.choices[0].message.content.strip()
            
        except Exception as e:
            print(f"OpenAI analysis failed: {e}")
            return self._get_fallback_analysis(risk_level)
    
    def _get_fallback_analysis(self, risk_level: str) -> str:
        """Fallback analysis if OpenAI is unavailable"""
        if risk_level == "Low Risk":
            return """
            рооро┐роХро╡рпБроорпН роиройрпНро▒рпБ! роЙроЩрпНроХро│рпН рокродро┐ро▓рпНроХро│рпН роиро▓рпНро▓ роорой роЖро░рпЛроХрпНроХро┐роп ро╡ро┐ро┤ро┐рокрпНрокрпБрогро░рпНро╡рпБ рооро▒рпНро▒рпБроорпН роЪрооро╛ро│ро┐рокрпНрокрпБ роЙродрпНродро┐роХро│рпИроХрпН роХро╛роЯрпНроЯрпБроХро┐ройрпНро▒рой. 
            роЖро░рпЛроХрпНроХро┐ропрооро╛рой рокро┤роХрпНроХроЩрпНроХро│рпИродрпН родрпКроЯро░рпНроирпНродрпБ рокро░ро╛рооро░ро┐роХрпНроХро╡рпБроорпН, роЙроЩрпНроХро│рпН роЖродро░ро╡рпБ ро╡ро▓рпИропроорпИрокрпНрокрпБроЯройрпН роЗрогрпИроирпНродро┐ро░рпБроЩрпНроХро│рпН, 
            рооро▒рпНро▒рпБроорпН ро╡ро┤роХрпНроХрооро╛рой роЪрпБроХро╛родро╛ро░ рокро░ро╛рооро░ро┐рокрпНрокрпБ роироЯрпИроорпБро▒рпИроХро│рпИродрпН родрпКроЯро░рпНроирпНродрпБ роЪрпЖропрпНропро╡рпБроорпН.
            """
        elif risk_level == "Medium Risk":
            return """
            роХрпВроЯрпБродро▓рпН роЖродро░ро╡рпИроХрпН роХро░рпБродрпНродро┐ро▓рпН роХрпКро│рпНро│рпБроЩрпНроХро│рпН. роЙроЩрпНроХро│рпН роЙрогро░рпНро╡рпБроХро│рпИрокрпН рокро▒рпНро▒ро┐ роЙроЩрпНроХро│рпН роЪрпБроХро╛родро╛ро░ рокро░ро╛рооро░ро┐рокрпНрокро╛ро│ро░рпБроЯройрпН рокрпЗроЪрпБроЩрпНроХро│рпН, 
            роЖродро░ро╡рпБ роХрпБро┤рпБро╡ро┐ро▓рпН роЪрпЗро░рпБро╡родрпИроХрпН роХро░рпБродрпНродро┐ро▓рпН роХрпКро│рпНро│рпБроЩрпНроХро│рпН, роЕро┤рпБродрпНродроорпН роХрпБро▒рпИрокрпНрокрпБ роирпБроЯрпНрокроЩрпНроХро│рпИрокрпН рокропро┐ро▒рпНроЪро┐ роЪрпЖропрпНропрпБроЩрпНроХро│рпН, 
            рооро▒рпНро▒рпБроорпН ро╡ро┤роХрпНроХрооро╛рой родрпВроХрпНроХроорпН рооро▒рпНро▒рпБроорпН роЙроЯро▒рпНрокропро┐ро▒рпНроЪро┐ ро╡ро┤роХрпНроХроЩрпНроХро│рпИрокрпН рокро░ро╛рооро░ро┐роХрпНроХро╡рпБроорпН.
            """
        else:
            return """
            родропро╡рпБроЪрпЖропрпНродрпБ роЖродро░ро╡рпИродрпН родрпЗроЯрпБроЩрпНроХро│рпН. роЙроЯройроЯро┐ропро╛роХ роЙроЩрпНроХро│рпН роЪрпБроХро╛родро╛ро░ рокро░ро╛рооро░ро┐рокрпНрокро╛ро│ро░рпИродрпН родрпКроЯро░рпНрокрпБ роХрпКро│рпНро│рпБроЩрпНроХро│рпН, 
            роорой роЖро░рпЛроХрпНроХро┐роп роиро┐рокрпБрогро░рпБроЯройрпН рокрпЗроЪрпБро╡родрпИроХрпН роХро░рпБродрпНродро┐ро▓рпН роХрпКро│рпНро│рпБроЩрпНроХро│рпН, роироорпНрокроХрооро╛рой роХрпБроЯрпБроорпНрокроорпН рооро▒рпНро▒рпБроорпН роирогрпНрокро░рпНроХро│ро┐роЯроорпН роЕрогрпБроХрпБроЩрпНроХро│рпН, 
            рооро▒рпНро▒рпБроорпН родрпЗро╡рпИрокрпНрокроЯрпНроЯро╛ро▓рпН роирпЖро░рпБроХрпНроХроЯро┐ роЖродро░ро╡рпБ ро╡ро│роЩрпНроХро│рпИроХрпН роХро░рпБродрпНродро┐ро▓рпН роХрпКро│рпНро│рпБроЩрпНроХро│рпН.
            """
    
    def _generate_recommendations(self, risk_level: str, percentage: float, answers: List[int]) -> List[str]:
        """Generate specific recommendations based on risk level"""
        if risk_level == "Low Risk":
            return [
                "роЙроЩрпНроХро│рпН роирпЗро░рпНрооро▒рпИропро╛рой рооройроиро┐ро▓рпИропрпИродрпН родрпКроЯро░рпНроирпНродрпБ рокро░ро╛рооро░ро┐роХрпНроХро╡рпБроорпН",
                "ро╡ро┤роХрпНроХрооро╛рой роЙроЯро▒рпНрокропро┐ро▒рпНроЪро┐ рооро▒рпНро▒рпБроорпН роЪроороиро┐ро▓рпИропро╛рой роЙрогро╡рпБ ро╡ро┤роХрпНроХродрпНродрпИродрпН родрпКроЯро░рпНроирпНродрпБ роЪрпЖропрпНропро╡рпБроорпН",
                "роХрпБроЯрпБроорпНрокроорпН рооро▒рпНро▒рпБроорпН роирогрпНрокро░рпНроХро│рпБроЯройрпН роирпЗро░рпНрооро▒рпИропро╛рой роЙро▒ро╡рпБроХро│рпИ ро╡ро│ро░рпНродрпНродрпБроХрпН роХрпКро│рпНро│рпБроЩрпНроХро│рпН",
                "роорой роЕро┤рпБродрпНродродрпНродрпИроХрпН роХрпБро▒рпИроХрпНроХрпБроорпН роироЯро╡роЯро┐роХрпНроХрпИроХро│ро┐ро▓рпН роИроЯрпБрокроЯрпБроЩрпНроХро│рпН"
            ]
        elif risk_level == "Mild Risk":
            return [
                "роЙроЩрпНроХро│рпН роЙрогро░рпНро╡рпБроХро│рпИрокрпН рокро▒рпНро▒ро┐ роироорпНрокроХрооро╛рой роирокро░рпБроЯройрпН рокрпЗроЪрпБроЩрпНроХро│рпН",
                "роЖро┤рпНроирпНрод роЪрпБро╡ро╛роЪроорпН рооро▒рпНро▒рпБроорпН родро┐ропро╛ройроорпН рокрпЛройрпНро▒ роЕро┤рпБродрпНродроорпН роХрпБро▒рпИрокрпНрокрпБ роирпБроЯрпНрокроЩрпНроХро│рпИрокрпН рокропро┐ро▒рпНроЪро┐ роЪрпЖропрпНропрпБроЩрпНроХро│рпН",
                "ро╡ро┤роХрпНроХрооро╛рой роЪрпБроХро╛родро╛ро░ рокро░ро╛рооро░ро┐рокрпНрокрпБ роироЯрпИроорпБро▒рпИроХро│рпИродрпН родрпКроЯро░рпНроирпНродрпБ роЪрпЖропрпНропро╡рпБроорпН",
                "роЙроЩрпНроХро│рпН роЪрпБроХро╛родро╛ро░ рокро░ро╛рооро░ро┐рокрпНрокро╛ро│ро░рпБроЯройрпН роЙроЩрпНроХро│рпН рооройроиро┐ро▓рпИропрпИрокрпН рокро▒рпНро▒ро┐ рокрпЗроЪрпБроЩрпНроХро│рпН"
            ]
        elif risk_level == "Medium Risk":
            return [
                "роЙроЯройроЯро┐ропро╛роХ роЙроЩрпНроХро│рпН роЪрпБроХро╛родро╛ро░ рокро░ро╛рооро░ро┐рокрпНрокро╛ро│ро░рпИродрпН родрпКроЯро░рпНрокрпБ роХрпКро│рпНро│рпБроЩрпНроХро│рпН",
                "роорой роЖро░рпЛроХрпНроХро┐роп роиро┐рокрпБрогро░рпБроЯройрпН роЖро▓рпЛроЪройрпИ рокрпЖро▒рпБро╡родрпИроХрпН роХро░рпБродрпНродро┐ро▓рпН роХрпКро│рпНро│рпБроЩрпНроХро│рпН",
                "роХрпБроЯрпБроорпНрок роЙро▒рпБрокрпНрокро┐ройро░рпНроХро│ро┐роЯроорпН роЙроЩрпНроХро│рпН роЙрогро░рпНро╡рпБроХро│рпИрокрпН рокроХро┐ро░рпНроирпНродрпБ роХрпКро│рпНро│рпБроЩрпНроХро│рпН",
                "роЖродро░ро╡рпБ роХрпБро┤рпБро╡ро┐ро▓рпН роЪрпЗро░рпБро╡родрпИроХрпН роХро░рпБродрпНродро┐ро▓рпН роХрпКро│рпНро│рпБроЩрпНроХро│рпН"
            ]
        elif risk_level == "High Risk":
            return [
                "роЙроЯройроЯро┐ропро╛роХ рооро░рпБродрпНродрпБро╡ роЖро▓рпЛроЪройрпИ рокрпЖро▒рпБроЩрпНроХро│рпН",
                "роорой роЖро░рпЛроХрпНроХро┐роп роиро┐рокрпБрогро░рпБроЯройрпН роЕро╡роЪро░рооро╛роХ рокрпЗроЪрпБроЩрпНроХро│рпН",
                "роХрпБроЯрпБроорпНрок роЙро▒рпБрокрпНрокро┐ройро░рпНроХро│ро┐роЯроорпН роЙродро╡ро┐ роХрпЗро│рпБроЩрпНроХро│рпН",
                "роирпЖро░рпБроХрпНроХроЯро┐ роЖродро░ро╡рпБ ро╡ро│роЩрпНроХро│рпИродрпН родрпКроЯро░рпНрокрпБ роХрпКро│рпНро│рпБроЩрпНроХро│рпН"
            ]
        else:  # Very High Risk
            return [
                "роЙроЯройроЯро┐ропро╛роХ роЕро╡роЪро░ рооро░рпБродрпНродрпБро╡ роЪрпЗро╡рпИроХро│рпИродрпН родрпКроЯро░рпНрокрпБ роХрпКро│рпНро│рпБроЩрпНроХро│рпН",
                "роорой роЖро░рпЛроХрпНроХро┐роп роиро┐рокрпБрогро░рпБроЯройрпН роЕро╡роЪро░рооро╛роХ рокрпЗроЪрпБроЩрпНроХро│рпН",
                "роирпЖро░рпБроХрпНроХроЯро┐ роЖродро░ро╡рпБ ро╡ро░ро┐ропрпИродрпН родрпКроЯро░рпНрокрпБ роХрпКро│рпНро│рпБроЩрпНроХро│рпН",
                "роХрпБроЯрпБроорпНрок роЙро▒рпБрокрпНрокро┐ройро░рпНроХро│ро┐роЯроорпН роЙроЯройроЯро┐ роЙродро╡ро┐ роХрпЗро│рпБроЩрпНроХро│рпН"
            ]
    
    def _generate_action_plan(self, risk_level: str, percentage: float) -> Dict[str, str]:
        """Generate specific action plan based on risk level"""
        if risk_level == "Low Risk":
            return {
                "immediate": "роЙроЩрпНроХро│рпН роирпЗро░рпНрооро▒рпИропро╛рой рооройроиро┐ро▓рпИропрпИродрпН родрпКроЯро░рпНроирпНродрпБ рокро░ро╛рооро░ро┐роХрпНроХро╡рпБроорпН",
                "short_term": "ро╡ро┤роХрпНроХрооро╛рой роЪрпБроХро╛родро╛ро░ рокро░ро╛рооро░ро┐рокрпНрокрпБ роироЯрпИроорпБро▒рпИроХро│рпИродрпН родрпКроЯро░рпНроирпНродрпБ роЪрпЖропрпНропро╡рпБроорпН",
                "long_term": "роЖро░рпЛроХрпНроХро┐ропрооро╛рой ро╡ро╛ро┤рпНроХрпНроХрпИ роорпБро▒рпИропрпИродрпН родрпКроЯро░рпНроирпНродрпБ рокро░ро╛рооро░ро┐роХрпНроХро╡рпБроорпН"
            }
        elif risk_level == "Mild Risk":
            return {
                "immediate": "роЙроЩрпНроХро│рпН роЪрпБроХро╛родро╛ро░ рокро░ро╛рооро░ро┐рокрпНрокро╛ро│ро░рпБроЯройрпН роЙроЩрпНроХро│рпН рооройроиро┐ро▓рпИропрпИрокрпН рокро▒рпНро▒ро┐ рокрпЗроЪрпБроЩрпНроХро│рпН",
                "short_term": "роЕро┤рпБродрпНродроорпН роХрпБро▒рпИрокрпНрокрпБ роирпБроЯрпНрокроЩрпНроХро│рпИрокрпН рокропро┐ро▒рпНроЪро┐ роЪрпЖропрпНропрпБроЩрпНроХро│рпН",
                "long_term": "ро╡ро┤роХрпНроХрооро╛рой роорой роЖро░рпЛроХрпНроХро┐роп роЖро▓рпЛроЪройрпИ рокрпЖро▒рпБроЩрпНроХро│рпН"
            }
        elif risk_level == "Medium Risk":
            return {
                "immediate": "роЙроЯройроЯро┐ропро╛роХ рооро░рпБродрпНродрпБро╡ роЖро▓рпЛроЪройрпИ рокрпЖро▒рпБроЩрпНроХро│рпН",
                "short_term": "роорой роЖро░рпЛроХрпНроХро┐роп роиро┐рокрпБрогро░рпБроЯройрпН роЖро▓рпЛроЪройрпИ рокрпЖро▒рпБроЩрпНроХро│рпН",
                "long_term": "ро╡ро┤роХрпНроХрооро╛рой роорой роЖро░рпЛроХрпНроХро┐роп рокро░ро╛рооро░ро┐рокрпНрокрпБ родро┐роЯрпНроЯродрпНродрпИродрпН родрпКроЯроЩрпНроХрпБроЩрпНроХро│рпН"
            }
        elif risk_level == "High Risk":
            return {
                "immediate": "роЙроЯройроЯро┐ропро╛роХ роорой роЖро░рпЛроХрпНроХро┐роп роиро┐рокрпБрогро░рпБроЯройрпН рокрпЗроЪрпБроЩрпНроХро│рпН",
                "short_term": "ро╡ро┤роХрпНроХрооро╛рой роорой роЖро░рпЛроХрпНроХро┐роп рокро░ро╛рооро░ро┐рокрпНрокрпБ родро┐роЯрпНроЯродрпНродрпИродрпН родрпКроЯроЩрпНроХрпБроЩрпНроХро│рпН",
                "long_term": "роирпАрогрпНроЯ роХро╛ро▓ роорой роЖро░рпЛроХрпНроХро┐роп роЖродро░ро╡рпБ рокрпЖро▒рпБроЩрпНроХро│рпН"
            }
        else:  # Very High Risk
            return {
                "immediate": "роЙроЯройроЯро┐ропро╛роХ роЕро╡роЪро░ рооро░рпБродрпНродрпБро╡ роЪрпЗро╡рпИроХро│рпИродрпН родрпКроЯро░рпНрокрпБ роХрпКро│рпНро│рпБроЩрпНроХро│рпН",
                "short_term": "роирпЖро░рпБроХрпНроХроЯро┐ роЖродро░ро╡рпБ ро╡ро│роЩрпНроХро│рпИрокрпН рокропройрпНрокроЯрпБродрпНродрпБроЩрпНроХро│рпН",
                "long_term": "ро╡ро┐ро░ро┐ро╡ро╛рой роорой роЖро░рпЛроХрпНроХро┐роп рокро░ро╛рооро░ро┐рокрпНрокрпБ родро┐роЯрпНроЯродрпНродрпИродрпН родрпКроЯроЩрпНроХрпБроЩрпНроХро│рпН"
            }
    
    def generate_audio(self, text: str) -> Dict[str, Any]:
        """Generate Tamil audio using ElevenLabs"""
        try:
            if not text or not text.strip():
                return {
                    "success": False,
                    "error": "Text is required and cannot be empty"
                }
            
            # Limit text length to prevent API abuse
            if len(text) > 5000:
                return {
                    "success": False,
                    "error": "Text is too long. Maximum 5000 characters allowed."
                }
            
            if not self.elevenlabs_api_key or self.elevenlabs_api_key == "your_elevenlabs_api_key_here":
                return {
                    "success": False,
                    "error": "ElevenLabs API key not configured",
                    "fallback": True
                }
            
            # Use a Tamil voice (Adam voice - good for Tamil)
            voice_id = "pNInz6obpgDQGcFmaJgB"
            
            # ElevenLabs API call
            url = f"https://api.elevenlabs.io/v1/text-to-speech/{voice_id}"
            
            headers = {
                "Accept": "audio/mpeg",
                "Content-Type": "application/json",
                "xi-api-key": self.elevenlabs_api_key
            }
            
            data = {
                "text": text,
                "model_id": "eleven_multilingual_v2",  # Better for Tamil
                "voice_settings": {
                    "stability": 0.5,
                    "similarity_boost": 0.5,
                    "style": 0.0,
                    "use_speaker_boost": True
                }
            }
            
            response = requests.post(url, json=data, headers=headers, timeout=15)
            
            if response.status_code != 200:
                return {
                    "success": False,
                    "error": "ElevenLabs API error",
                    "fallback": True
                }
            
            if not response.content or len(response.content) < 1000:
                return {
                    "success": False,
                    "error": "Audio response too small",
                    "fallback": True
                }
            
            # Return audio data as base64
            import base64
            audio_base64 = base64.b64encode(response.content).decode('utf-8')
            
            return {
                "success": True,
                "audio_data": audio_base64,
                "audio_type": "audio/mpeg",
                "size": len(response.content)
            }
            
        except Exception as e:
            print(f"Audio generation error: {e}")
            return {
                "success": False,
                "error": f"Error generating audio: {str(e)}",
                "fallback": True
            }

    def generate_chat_response(self, message: str, patient_id: str, context: str = None, 
                             mood: str = None, session_id: str = None, 
                             user_profile: Dict[str, Any] = None) -> Dict[str, Any]:
        """Generate AI chat response for mental health support"""
        try:
            if not self.openai_client:
                return self._generate_fallback_chat_response(message, mood)
            
            # Build context-aware prompt
            system_prompt = self._build_chat_system_prompt(mood, user_profile)
            
            # Create conversation context
            conversation_context = self._build_conversation_context(context, session_id)
            
            # Generate response using OpenAI
            response = self.openai_client.chat.completions.create(
                model="gpt-3.5-turbo",
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": f"{conversation_context}\n\nUser: {message}"}
                ],
                max_tokens=500,
                temperature=0.7
            )
            
            ai_response = response.choices[0].message.content.strip()
            
            # Generate suggestions based on the response
            suggestions = self._generate_suggestions(message, ai_response, mood)
            
            return {
                "success": True,
                "message": ai_response,
                "message_type": "supportive",
                "suggestions": suggestions,
                "metadata": {
                    "mood": mood,
                    "context": context,
                    "session_id": session_id,
                    "timestamp": datetime.now().isoformat()
                },
                "session_id": session_id,
                "requires_follow_up": self._requires_follow_up(message, ai_response)
            }
            
        except Exception as e:
            print(f"Chat response generation error: {e}")
            return self._generate_fallback_chat_response(message, mood)
    
    def _build_chat_system_prompt(self, mood: str = None, user_profile: Dict[str, Any] = None) -> str:
        """Build system prompt for mental health chat"""
        base_prompt = """You are a compassionate AI mental health support assistant for pregnant women. 
        Your role is to provide emotional support, guidance, and encouragement while being mindful of 
        pregnancy-related mental health concerns.
        
        Guidelines:
        - Be empathetic, non-judgmental, and supportive
        - Focus on pregnancy-safe mental health advice
        - Encourage professional help when appropriate
        - Provide practical coping strategies
        - Use warm, understanding language
        - Avoid medical advice - refer to healthcare providers for medical concerns
        - Be culturally sensitive and inclusive"""
        
        if mood:
            mood_context = f"\n\nCurrent mood context: The user is feeling {mood}. Adjust your response accordingly."
            base_prompt += mood_context
        
        if user_profile and user_profile.get('pregnancy_stage'):
            stage = user_profile['pregnancy_stage']
            base_prompt += f"\n\nPregnancy stage: {stage}. Consider stage-specific mental health concerns."
        
        return base_prompt
    
    def _build_conversation_context(self, context: str = None, session_id: str = None) -> str:
        """Build conversation context for better responses"""
        context_parts = []
        
        if context:
            context_parts.append(f"Previous context: {context}")
        
        if session_id:
            context_parts.append(f"Session ID: {session_id}")
        
        return "\n".join(context_parts) if context_parts else ""
    
    def _generate_suggestions(self, user_message: str, ai_response: str, mood: str = None) -> List[str]:
        """Generate helpful suggestions based on the conversation"""
        suggestions = []
        
        # Mood-based suggestions
        if mood and mood.lower() in ['sad', 'anxious', 'stressed']:
            suggestions.extend([
                "Try deep breathing exercises",
                "Consider talking to your healthcare provider",
                "Practice gentle pregnancy-safe exercises"
            ])
        elif mood and mood.lower() in ['happy', 'excited', 'positive']:
            suggestions.extend([
                "Keep up the positive mindset!",
                "Share your joy with loved ones",
                "Document these happy moments"
            ])
        
        # General helpful suggestions
        suggestions.extend([
            "Practice mindfulness or meditation",
            "Connect with other expecting mothers",
            "Maintain a healthy sleep routine"
        ])
        
        return suggestions[:3]  # Return top 3 suggestions
    
    def _requires_follow_up(self, user_message: str, ai_response: str) -> bool:
        """Determine if the conversation requires follow-up"""
        concerning_keywords = [
            'harm', 'hurt', 'suicide', 'self-harm', 'end it all',
            'hopeless', 'worthless', 'can\'t go on', 'give up'
        ]
        
        user_lower = user_message.lower()
        return any(keyword in user_lower for keyword in concerning_keywords)
    
    def _generate_fallback_chat_response(self, message: str, mood: str = None) -> Dict[str, Any]:
        """Generate fallback response when OpenAI is not available"""
        fallback_responses = [
            "I'm here to listen and support you. How are you feeling today?",
            "It's completely normal to have mixed emotions during pregnancy. You're doing great!",
            "Remember, it's okay to not be okay sometimes. You're not alone in this journey.",
            "Pregnancy can bring many emotions. Take things one day at a time.",
            "Your feelings are valid. Would you like to talk about what's on your mind?"
        ]
        
        # Select response based on mood if available
        if mood and mood.lower() in ['sad', 'anxious', 'stressed']:
            response = "I can sense you're going through a tough time. Remember, it's okay to feel this way during pregnancy. You're stronger than you know, and there are people who care about you."
        else:
            response = random.choice(fallback_responses)
        
        return {
            "success": True,
            "message": response,
            "message_type": "supportive",
            "suggestions": [
                "Consider talking to your healthcare provider",
                "Practice deep breathing exercises",
                "Connect with supportive friends or family"
            ],
            "metadata": {
                "mood": mood,
                "fallback": True,
                "timestamp": datetime.now().isoformat()
            },
            "requires_follow_up": False
        }